# Add a piecewise cost function that steadily increases investment costs with increasing technology rated capacity.
# This requires the user to switch on the binary purchase decision variable for any relevant technology.
# Without the purchase decision variable, the technology will have non-zero costs irrespective even if the technology capacity is zero.

# New top-level parameters:
# cost_flow_out_cap_piecewise_slopes (defining the new parameter `pieces`)
# cost_flow_out_cap_piecewise_intercept (defining the new parameter `pieces`)

variables:
  piecewise_cost_investment:
    description: Investment cost that increases monotonically
    foreach: [nodes, techs, costs]
    where: cost_flow_out_cap_piecewise_slopes AND cost_flow_out_cap_piecewise_intercept AND purchased
    bounds:
      min: 0
      max: .inf

constraints:
  piecewise_costs:
    description: >
      Limit the lower bound of piecewise investment costs to monotonically increasing values.
      Since the model is cost minimising, this is equivalent to forcing the investment cost to a specific point along the curve that is traced by the superposition of all pieces.
    foreach: [nodes, techs, costs, pieces]
    where: piecewise_cost_investment
    equations:
      - expression: >
          piecewise_cost_investment >=
          cost_flow_out_cap_piecewise_slopes * flow_out_cap + cost_flow_out_cap_piecewise_intercept * purchased

# We inject this new source of into the `cost` global expression
global_expressions:
  cost:
    foreach: [nodes, techs, costs]
    where: "cost_investment OR cost_var OR piecewise_cost_investment"
    equations:
      - expression: $cost_investment + $cost_var_sum + $piecewise_cost_investment
    sub_expressions:
      piecewise_cost_investment:
        - where: "piecewise_cost_investment"
          expression: annualisation_weight * cost_depreciation_rate * piecewise_cost_investment
        - where: "NOT piecewise_cost_investment"
          expression: "0"
